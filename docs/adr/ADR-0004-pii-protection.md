# ADR-0004: Защита PII в модуле «Водители»

**Status:** accepted

**Date:** 2025-09-23

## Context

Модуль «Водители» хранит и обрабатывает персональные данные (RČ, паспорта, IBAN/SWIFT, номера тахокарт). Требуется минимальный, но цельный security-pack: защита данных в покое и при доступе, контроль раскрытия, аудит обращений и соответствие требованиям EU GDPR.

## Decision

* **Шифрование полей**: симметричный алгоритм AES-256-GCM, ключи хранятся в Railway secrets (`ENCRYPTION_KEY_V1`, `ENCRYPTION_KEY_PREV`). Для поиска по полям используем слепые индексы (HMAC-SHA-256 + соль `HASH_SALT`).
* **RLS**: для таблицы `drivers` включается Row Level Security с политиками на основе `app_role` из заголовка `APP_ROLE_HEADER`. Просмотр незашифрованных данных доступен только ролям `operations.admin` и `support.senior`.
* **Audit trail**: все запросы `POST /drivers/:id/reveal` пишут в таблицу `audit_driver_reveals` (id пользователя, роль, драйвер, причина, таймштамп).
* **Mask by default**: GET-эндпоинты возвращают только маскированные значения, фронт отображает «Reveal» с серверной проверкой ролей.

## Alternatives

* **PostgreSQL `pgcrypto`** — отвергнуто: отсутствует встроенный аудит и blind index, сложнее перенос между БД.
* **Managed KMS (AWS/GCP)** — отвергнуто: текущий хостинг на Railway, переезд на облако > 3 месяцев.
* **HashiCorp Vault** — отвергнуто: требует выделенный сервис и операционные ресурсы, избыточно для текущего масштаба.

## Consequences

* Увеличение задержек при чтении/записи из-за шифрования и вычисления индексов.
* Требуется дисциплина по управлению ключами и солями.
* Расширенный процесс онбординга для ролей с доступом к `reveal`.

## План ротации ключей

1. **Подготовка**: генерируем новый ключ `ENCRYPTION_KEY_V_NEXT`, добавляем его как `ENCRYPTION_KEY_V1`, предыдущий переименовываем в `ENCRYPTION_KEY_PREV`.
2. **Миграция данных**: бэкап базы, запускаем мигратор — декодируем старыми ключами, шифруем новым (online, батчами ≤ 1000 записей).
3. **Валидация**: проверяем контрольные выборки (5% записей), мониторим ошибки дешифрования.
4. **Завершение**: удаляем устаревший секрет, обновляем документацию и аудит.
5. **Регулярность**: минимум 1 раз в 6 месяцев либо при подозрении на компрометацию.
