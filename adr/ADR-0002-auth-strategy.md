# ADR-0002: Auth Strategy

- Status: Accepted
- Date: 2025-09-21
- Deciders: Core Platform Team

## Контекст

Пользователи GTrack входят через корпоративные учетные записи Google Workspace и Microsoft 365. Требуется унифицированная авторизация с безопасным хранением сессий и минимальной задержкой для фронтенда.

## Решение

- Используем OAuth 2.0 / OpenID Connect провайдеров Google и Microsoft.
- Фронтенд инициирует авторизацию через `response_type=code` и после редиректа передает `code` на backend callback.
- Backend валидирует `id_token`: проверка подписи, `aud`, `iss`, срока действия и соответствия корпоративному домену.
- После успешной валидации backend обменивает данные на httpOnly-сессию (JWT или opaque token) и возвращает `Set-Cookie` с `Secure`, `HttpOnly`, `SameSite=Lax`.
- Сессия хранит идентификатор пользователя, список ролей, время обновления. Продление — через refresh endpoint с повторной проверкой провайдера при необходимости.
- Высокоуровневый поток: пользователь → OAuth провайдер → backend callback → валидация токена → установка httpOnly cookie → редирект в приложение.

## Последствия

- Фронтенд не хранит чувствительные токены, минимизируя риск XSS-утечек.
- Требуется единый callback endpoint `/api/auth/callback` с маршрутизацией по провайдеру.
- Необходимо вести аудит отказов (invalid domain, expired token) и поддерживать ручное завершение сессии.
