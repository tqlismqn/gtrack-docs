# ADR-0002: Auth Strategy

- Status: Accepted
- Date: 2025-09-21
- Deciders: Core Platform Team

## Контекст

Пользователи GTrack входят через корпоративные учетные записи Google Workspace и Microsoft 365. Нужен единый механизм аутентификации, совместимый с политиками безопасности компаний, который изолирует чувствительные токены от фронтенда и позволяет централизованно управлять сессиями.

## Решение

Выбираем стратегию на основе OAuth 2.0 / OpenID Connect с провайдерами Google и Microsoft. Высокоуровневый поток выглядит так:

1. Пользователь инициирует вход и выбирает провайдера (Google или Microsoft).
2. Фронтенд перенаправляет пользователя на страницу авторизации провайдера с параметрами PKCE.
3. Провайдер возвращает `authorization_code` на backend-эндпоинт `/api/auth/callback`.
4. Backend обменивает код на `id_token` и `access_token`, валидирует подпись, `audience`, `issuer`, `exp` и корпоративные домены.
5. Backend создает httpOnly-сессию (JWT или opaque token), устанавливает cookie с флагами `Secure`, `SameSite=Lax`, `HttpOnly` и сохраняет минимальные атрибуты пользователя и ролей.
6. Фронтенд получает подтверждение, обновляет состояние пользователя и работает исключительно с cookie-сессией; рефреш выполняется через backend при истечении срока действия.

## Последствия

- Фронтенд не хранит чувствительные токены, минимизируя риск XSS-утечек.
- Требуется единый callback endpoint с маршрутизацией по провайдеру и аудитом отказов (invalid domain, expired token).
- Необходимо логирование и ручное завершение сессий для соответствия политикам безопасности.
