# ADR-0002: Auth Strategy

- Status: Accepted
- Date: 2025-09-21
- Deciders: Core Platform Team

## Контекст

Пользователи GTrack входят через корпоративные учетные записи Google Workspace и Microsoft 365. Требуется унифицированная авторизация с безопасным хранением сессий и минимальной задержкой для фронтенда.

## Решение

- Используем OAuth 2.0 / OpenID Connect провайдеров Google и Microsoft.
- Фронтенд получает код авторизации и обменивает его на токен через backend callback.
- Backend валидирует id_token/доступ: проверка подписи, аудит audience, issuer, времени жизни и доменных ограничений.
- Backend создает httpOnly-сессию (JWT или opaque token) и возвращает Set-Cookie с атрибутами `Secure`, `SameSite=Lax`.
- Сессия хранит идентификатор пользователя, список ролей, время обновления. Продление — через refresh endpoint с повторной проверкой провайдера при необходимости.

## Последствия

- Фронтенд не хранит чувствительные токены, минимизируя риск XSS-утечек.
- Требуется единый callback endpoint `/api/auth/callback` с маршрутизацией по провайдеру.
- Необходимо вести аудит отказов (invalid domain, expired token) и поддерживать ручное завершение сессии.
