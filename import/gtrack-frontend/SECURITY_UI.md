# UI безопасности: маскирование PII

Этот документ описывает принципы отображения персональных данных в интерфейсе и компонент `MaskedValue`, который реализует поток запроса доступа к PII.

## Компонент `MaskedValue`

- Находится в `app/components/MaskedValue.tsx`.
- Отрисовывает значение в зашифрованном виде по умолчанию (формат `****1234`, видны только последние 4 символа).
- Показывает кнопку **Reveal**. После успешного получения значения кнопка переключается в состояние **Hide**; повторных сетевых запросов в рамках сессии не выполняется.
- Использует `sessionStorage` (`gtrack:driver:pii:<driverId>:<field>`) для кеширования раскрытых значений. Состояние пустых ответов также кешируется.
- Делает POST-запрос `POST /drivers/:id/reveal` с телом `{ fields: [field], purpose }`, где `purpose` по умолчанию `driver_pii_view`.
- Кнопка недоступна, если роль текущего пользователя не входит в список разрешённых (`admin`, `hr`) или если не задан `NEXT_PUBLIC_API_URL`.
- Отрисовывает состояния:
  - **Loading** — индикатор текста «Загрузка…» на кнопке.
  - **Error** — текст ошибки рядом с кнопкой при неуспешном запросе.
  - **Empty** — значение «Нет данных», если поле отсутствует.

## Роли и управление доступом

- Право на запрос PII есть только у ролей `admin` и `hr`.
- Для прототипа роль можно задать через `sessionStorage.setItem('gtrack-role', 'admin')` или переменную окружения `NEXT_PUBLIC_DEFAULT_ROLE` (см. ниже).
- Все остальные роли видят замаскированные значения и не могут инициировать запрос.

## Внедрение на карточку водителя

- Компонент `MaskedValue` используется для полей: RČ (`national_id_rc`), паспорт, водительское удостоверение, IBAN, SWIFT, карта тахографа.
- Каждое поле передаёт идентификатор водителя (`driver.id` или его суррогатный ключ) и имя поля для API.
- После получения значения повторный клик по **Hide** возвращает маску без запроса к API.

## Переменные окружения

- `NEXT_PUBLIC_API_URL` — базовый URL API (используется при загрузке списка водителей и запросе расшифровки).
- `NEXT_PUBLIC_DEFAULT_ROLE` — необязательная переменная для локальной разработки, позволяет выставить роль по умолчанию (`admin`, `hr` или `viewer`).

## UX-штрихи

- Сообщение «Недостаточно прав» отображается, если кнопка **Reveal** недоступна из-за роли.
- Ошибки сети и ответов сервера выводятся пользователю и не сбрасывают кеш; повторная попытка потребует повторного нажатия после устранения причины.
- Пустые значения остаются пустыми даже после запроса и не считаются ошибкой.
